From 499d5e4e3beb472a90d61e7d8e5a32fda9383799 Mon Sep 17 00:00:00 2001
From: SiqiWan <704252212@qq.com>
Date: Sun, 12 May 2024 13:43:02 -0400
Subject: [PATCH] Update GetParentTagsByCommit

---
 pkg/handler/branch_test.go             |  2 +-
 pkg/handler/commit_request_response.go |  1 -
 pkg/handler/tag.go                     | 27 ++++++++++----------------
 3 files changed, 11 insertions(+), 19 deletions(-)

diff --git a/pkg/handler/branch_test.go b/pkg/handler/branch_test.go
index a856d0a..362a05e 100644
--- a/pkg/handler/branch_test.go
+++ b/pkg/handler/branch_test.go
@@ -127,4 +127,4 @@ func Test_checkIfBranchExists(t *testing.T) {
 			}
 		})
 	}
-}
\ No newline at end of file
+}
diff --git a/pkg/handler/commit_request_response.go b/pkg/handler/commit_request_response.go
index 054174f..5a75dd7 100644
--- a/pkg/handler/commit_request_response.go
+++ b/pkg/handler/commit_request_response.go
@@ -1,4 +1,3 @@
-
 package handler
 
 import (
diff --git a/pkg/handler/tag.go b/pkg/handler/tag.go
index b540940..5fab50b 100644
--- a/pkg/handler/tag.go
+++ b/pkg/handler/tag.go
@@ -75,9 +75,6 @@ func (h *tagHandler) GetChildTagsByCommit(w http.ResponseWriter, r *http.Request
 		var commits []Commit
 		apiURL = fmt.Sprintf("https://api.github.com/repos/%s/%s/commits?sha=%s", owner, repo, sha)
 		resp, err = client.R().SetResult(&commits).Get(apiURL)
-		for _, c := range commits {
-			fmt.Println(c.SHA)
-		}
 		if err != nil {
 			http.Error(w, "Failed to fetch branches from the GitHub API", http.StatusInternalServerError)
 			return
@@ -163,15 +160,12 @@ func (h *tagHandler) GetParentTagsByCommit(w http.ResponseWriter, r *http.Reques
 	}
 
 	// for each branch, get parent tags for the commit
-	parentTagsByBranch := make(map[string][]string)
+	parentTagsByBranch := make(map[string]string)
 	for _, b := range repoBranches {
 		sha := b.Commit.SHA
 		var commits []Commit
 		apiURL = fmt.Sprintf("https://api.github.com/repos/%s/%s/commits?sha=%s", owner, repo, sha)
 		resp, err = client.R().SetResult(&commits).Get(apiURL)
-		for _, c := range commits {
-			fmt.Println(c.SHA)
-		}
 		if err != nil {
 			http.Error(w, "Failed to fetch branches from the GitHub API", http.StatusInternalServerError)
 			return
@@ -182,22 +176,21 @@ func (h *tagHandler) GetParentTagsByCommit(w http.ResponseWriter, r *http.Reques
 		}
 
 		commitFound := false
-		parentTags := make([]string, 0)
 		for _, c := range commits {
-			if commitTagMap[c.SHA] != "" {
-				parentTags = append(parentTags, commitTagMap[c.SHA])
-			}
 			if strings.HasPrefix(c.SHA, commitSha) {
 				commitFound = true
-				break
+			}
+			if commitTagMap[c.SHA] != "" && commitFound {
+				parentTagsByBranch[b.Name] = commitTagMap[c.SHA]
 			}
 		}
+	}
 
-		if !commitFound {
-			parentTags = []string{}
-		}
-
-		parentTagsByBranch[b.Name] = parentTags
+	response := GetParentTagsByCommitResp{
+		Tags: parentTagsByBranch,
 	}
 
+	w.Header().Set("Content-Type", "application/json")
+	w.WriteHeader(http.StatusOK)
+	_ = json.NewEncoder(w).Encode(response)
 }
-- 
2.39.3 (Apple Git-145)

